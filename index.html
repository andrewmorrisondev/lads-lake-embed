<!DOCTYPE html>
  <html lang='en'>
  <head>
      <meta charset='UTF-8'>
      <meta name='viewport' content='width=device-width, initial-scale=1.0'>
      <title>Geolocation iFrame</title>
  </head>
  <body>
      <script>

        // BROOKLYN FRISBEES
        //   let frisbeePositions = [[40.6964, -73.9101],[40.6965, -73.9102],[40.6966, -73.9103],[40.6966, -73.9104],[40.6966, -73.9105],[40.6966, -73.9106],[40.6966, -73.9107],[40.6966, -73.9108],[40.6966, -73.9109],[40.6966, -73.9110],[40.6966, -73.9111],[40.6955, -73.9095],[40.6950, -73.9093]]

        // LG FRISBEES
        let frisbeePositions = [
            [43.4015, -73.7230],
            [43.401470344308215, -73.72295374528123],
            [43.40144068861643, -73.72290749056246],
            [43.40141103292465, -73.7228612358437],
            [43.401381377232866, -73.72281498112493],
            [43.40135172154108, -73.72276872640616],
            [43.4013220658493, -73.72272247168739],
            [43.40129241015752, -73.72267621696862],
            [43.40126275446573, -73.72262996224985],
            [43.40123309877395, -73.72258370753109],
            [43.40120344308217, -73.72253745281232],
            [43.401173787390384, -73.72249119809355],
            [43.4011441316986, -73.72244494337478]
        ];

        let watchID = null;
        let lastLat = null;
        let lastLon = null;

        function determineDistanceAndDirection(startPos, endPos){
            let distAndDirection = {distance: "0", direction: "", giveClue: 'false'};
            let [a,b] = startPos;
            let [x,y] = endPos;
            a *= 364000;
            b *= 364000;
            x *= 364000;
            y *= 364000;
            distAndDirection.distance = Math.floor(Math.sqrt(Math.pow(Math.abs(a-x), 2) + Math.pow(Math.abs(b-y),2))).toString();
            
            if (parseInt(distAndDirection.distance) > 20){
                let ns = "", ew = "";
                if(Math.abs(a-x)>20 && a<x){ ns = "North" };
                if(Math.abs(b-y)>20 && b<y){ ew = "East" };
                if(Math.abs(a-x)>20 && a>x){ ns = "South" };
                if(Math.abs(b-y)>20 && b>y){ ew = "West" };
                distAndDirection.direction = ns + ew;
            } else {
                distAndDirection.direction = "You Made It";
                distAndDirection.giveClue = 'true';
            }
            return distAndDirection;
        }

        function startWatching() {
            if (navigator.geolocation) {
                if (watchID === null) {
                    watchID = navigator.geolocation.watchPosition(
                        (position) => {
                            // Only process the position if the accuracy is below 20 meters
                            if (position.coords.accuracy > 20) {
                                console.log("Position accuracy not sufficient: " + position.coords.accuracy + " meters");
                            }

                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;

                            // Ignore small changes in position (e.g., less than 0.00001 degrees)
                            if (lastLat !== null && lastLon !== null) {
                                const latDifference = Math.abs(lat - lastLat);
                                const lonDifference = Math.abs(lon - lastLon);
                                if (latDifference < 0.00001 && lonDifference < 0.00001) {
                                    // Position change is too small, ignore this update
                                    console.log("Small position change, ignoring...");
                                    return;
                                }
                            }

                            // Update last known position
                            lastLat = lat;
                            lastLon = lon;

                            let data = { user: { latitude: lat, longitude: lon } };
                            frisbeePositions.forEach((position, i) => {
                                let dataToFrisbee = determineDistanceAndDirection([lat, lon], position);
                                dataToFrisbee.latitude = position[0];
                                dataToFrisbee.longitude = position[1];
                                data[`fris${i + 1}`] = dataToFrisbee;
                            });

                            // Send the latitude and longitude to the parent container
                            // and for each frisbee number: latitude, longitude, distance (in feet), direction, clue boolean
                            window.parent.postMessage(data, '*');
                            console.log("latitude: ", lat);
                            console.log("longitude: ", lon);
                            console.log("data: ");
                            console.log(data);
                        },
                        (error) => {
                            switch (error.code) {
                                case error.PERMISSION_DENIED:
                                    console.error('User denied the request for Geolocation.');
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    console.error('Location information is unavailable.');
                                    break;
                                case error.TIMEOUT:
                                    console.error('The request to get user location timed out.');
                                    break;
                                case error.UNKNOWN_ERROR:
                                    console.error('An unknown error occurred.');
                                    break;
                            }
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,  // Increase timeout to 10 seconds for better accuracy
                            maximumAge: 0    // Ensure fresh location data, no cached values
                        }
                    );
                } else {
                    console.log('Already watching position.');
                }
            } else {
                console.error('Geolocation is not supported by this browser.');
            }
        }

        function stopWatching() {
            if (watchID !== null) {
                navigator.geolocation.clearWatch(watchID);
                console.log('Stopped watching position.');
                watchID = null;
            }
        }

        // Automatically start watching when the iframe loads
        window.onload = startWatching;
      </script>
  </body>
</html>
